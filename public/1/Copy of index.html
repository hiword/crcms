<!DOCTYPE html>
<html ng-app="app">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../vendor/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="static/css/basic.css" />
<link rel="stylesheet" href="vendor/font-awesome/4.5.0/css/font-awesome.min.css" />
<title>Insert title here</title>
</head>
<body>
<div class="main-left pull-left">
	<div class="left-top">
		<h1 class="logo"><a href="#/">CRCMS</a></h1>
		<div class="main-nav mt20">
			<ul class="nav nav-pills nav-stacked">
			  <li role="presentation" class="active"><a href="#">Home</a></li>
			  <li role="presentation"><a href="#/bookmark">Bookmark</a></li>
			  <li role="presentation"><a href="#/book">Book</a></li>
			  <li role="presentation"><a href="#/about">About</a></li>
			</ul>
		</div>
	</div>
	<div class="left-bottom">
		<h2 style="font-size:16px;">致力于打造全面化的开源CMS系统</h2>
		<p>
			<a href="###"><i class="fa fa-qq fa-lg"></i></a>
			<a href="https://github.com/hiword/crcms" target="_blank" class="ml10"><i class="fa fa-github fa-lg"></i></a>
			<a href="###" class="ml10"><i class="fa fa-envelope fa-lg"></i></a>
		</p>
		<p>
			Copyright <!-- © --><i class="fa fa-copyright"></i> 2013-2014
		</p>
	</div>
</div>
<div class="main-right pull-right">
	
		<div ui-view></div>
	
</div>
<!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
<script src="../static/common/js/jquery-2.1.3.min.js"></script>
<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="../vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="../vendor/angularjs/1.4.8/angular.min.js"></script>
<script src="../vendor/ui-router/angular-ui-router.min.js"></script>
<script>
function url(url)
{
	return 'http://3.cs/index.php/'+url;
}
	var app = angular.module('app',['ui.router'],['$httpProvider',function($httpProvider){
		$httpProvider.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded;charset=utf-8';
		
		/**
		   * The workhorse; converts an object to x-www-form-urlencoded serialization.
		   * @param {Object} obj
		   * @return {String}
		   */ 
		  var param = function(obj) {
		    var query = '', name, value, fullSubName, subName, subValue, innerObj, i;
		      
		    for(name in obj) {
		      value = obj[name];
		        
		      if(value instanceof Array) {
		        for(i=0; i<value.length; ++i) {
		          subValue = value[i];
		          fullSubName = name + '[' + i + ']';
		          innerObj = {};
		          innerObj[fullSubName] = subValue;
		          query += param(innerObj) + '&';
		        }
		      }
		      else if(value instanceof Object) {
		        for(subName in value) {
		          subValue = value[subName];
		          fullSubName = name + '[' + subName + ']';
		          innerObj = {};
		          innerObj[fullSubName] = subValue;
		          query += param(innerObj) + '&';
		        }
		      }
		      else if(value !== undefined && value !== null)
		        query += encodeURIComponent(name) + '=' + encodeURIComponent(value) + '&';
		    }
		      
		    return query.length ? query.substr(0, query.length - 1) : query;
		  };

		  // Override $http service's default transformRequest
		  $httpProvider.defaults.transformRequest = [function(data) {
		    return angular.isObject(data) && String(data) !== '[object File]' ? param(data) : data;
		  }];
	}]);
	app.config(['$stateProvider','$urlRouterProvider',function($stateProvider,$urlRouterProvider){
		$urlRouterProvider.otherwise('/');
		$stateProvider.state('home',{
			url:'/',
			templateUrl:'home.html',
			controller:'listController',
		})
		.state('detail',{
			url:'/detail/{id}/{hash}',
			templateUrl:'detail.html',
			controller:'detailController',
		})
	}]);
	//factory 使用于功能简单，类似于单例的一样，service适用于逻辑处理比较复杂的方法
	app.factory('documentListFactory',['$http','$q',function($http,$q){
		var documentListFactory = {
			documentIds:[],
			hashs:[],
			documents:function(page){
				page = page || 1;
				console.log(page);
				//申明一个延迟
				var deferred = $q.defer();
				
				//http数据获取
				$http.get(url('document/api/page?page='+page),{
					'page':page
				})
				.success(function(response){
					
					//获取所有的document id
					angular.forEach(response.data.models,function(values){
						documentListFactory.documentIds.push(values.id);
						documentListFactory.hashs.push(values.hash);
					});
					
					//解析documents
					deferred.resolve(response.data);
				})
				.error(function(response){
					deferred.reject(response);
				});
				
				return deferred.promise;
			}
		}
		return documentListFactory;
	}]);
	
	app.factory('documentDataFactory',['$http','$q',function($http,$q){
		var documentDataFactory = {
			stripTagsData:[],
			datas:function(ids,hashs){
				var deferred = $q.defer();
				
				$http.post(url('document/api/document-data'),{
					'id':ids,
					'hash':hashs,
				})
				.success(function(response){
					/* angular.forEach(response.data.data,function(item){
						item.content = strip_tags(item);
						documentDataFactory.stripTagsData.push(item);
					}); */
					var models = response.data.models;
					if(models)
					{
						var newModels = {};
						angular.forEach(models,function(model){
							newModels[model.did] = model;
						})	
						deferred.resolve(newModels);
					}
					else
					{
						deferred.resolve(models);	
					}
					
				})
				.error(function(response){
					deferred.reject(response);
				})
				
				return deferred.promise;
			}
		};
		return documentDataFactory;
	}]);
	
	app.factory('documentTagsFactory',['$http','$q','documentListFactory',function($http,$q,documentListFactory){
		//申明一个延迟
		return {
			tags:function(ids)
			{
				var deferred = $q.defer();
				
				$http.post('http://3.cs/index.php/tags/assoc-tags',{
					'id':documentListFactory.documentIds,
					'model':'Document\\Models\\Document'
				})
				.success(function(response){
					
					deferred.resolve(response.data.tags);
				})
				.error(function(response){
					deferred.reject(response);
				});
				
				return deferred.promise;
			}
		}
	}]);
	
	app.factory('documentDetail',['$http','$q',function($http,$q){
		var documentDetail = {
				query:function(id,hash)
				{
					//申明一个延迟
					var deferred = $q.defer();
					
					$http.post(url('document/api/show'),{
						'id':id,
						'hash':hash,
					}).success(function(response){
						deferred.resolve(response.data.model);
					}).error(function(response){
						deferred.reject(response);
					})
					
					return deferred.promise;
				}
		};
		return documentDetail;
	}]);
	
	app.controller('detailController',['$scope','$http','$stateParams','documentDetail',function($scope,$http,$stateParams,documentDetail){
		$scope.hello = 'abc';
		documentDetail.query($stateParams.id,$stateParams.hash).then(function(response){
			console.log(response);
			$scope.model = response;
		});
		/* console.log($stateParams);
		console.log($stateParams.id);
		console.log($stateParams.hash); */
	}]);
	app.controller('listController',['$scope','$http','$q','$sce','documentListFactory','documentTagsFactory','documentDataFactory',function($scope,$http,$q,$sce,documentListFactory,documentTagsFactory,documentDataFactory){
		/* documentListFactory.a().then(function(response]){
			$scope.lists = response
		}) */
		
		var b = function(page){
			documentListFactory.documents(page).then(function(response){
				
				$scope.lists = response.models;
				//$scope.page = $sce.trustAsHtml(response.page);
				$scope.current_page = parseInt(response.page_json.current_page)+1;

				
				documentTagsFactory.tags(documentListFactory.documentIds).then(function(response){
					/* console.log(response);
					$scope.tags = response; */
				})
				
				documentDataFactory.datas(documentListFactory.documentIds,documentListFactory.hashs).then(function(response){
					/* console.log(response); */
					$scope.datas = response;
					$scope.img = url('image/test/5%252F4%252Fo_1acc4jd2c1gk1la21plpg181kfd7.jpg');
				});
			});
		}
		
		b(1);
		
		/* $scope.name = 'abc'; */
		
		$scope.a_next = function(page){
			b(page);
		}
		
		

		/* documentListFactory.then(function(response){
			if(response.status == 1000)
			{
				var ids = [];
				
				angular.forEach(response.data.models,function(values){
					ids.push(values.id);
				});
				
				documentTagsFactory.query(ids).then(function(response){
					console.log(response);
				});
			}
		}); */
		/* documentListFactory.then(function(data){
			
		}) */
	}]);
	
	
	
	
	
	$(function(){
		/* $.get('http://3.cs/index.php?_json=1&_content=1',function(data){
			console.log(data);
		}) */
	})
</script>

<!-- 

app.controller('listController',['$scope','$http','$q','documentListFactory','documentTagsFactory',function($scope,$http,$q,documentListFactory,documentTagsFactory){
		
		documentListFactory.then(function(data){
			console.log(data);
		});
		
		//var promise = documentListFactory;
		//then方法// 调用承诺API获取数据
		//var documentList = {};
		//var tagsList = {};
		/*documentListFactory.then(function(data){
			documentList = data.data.models;
			console.log(1);
		});*/
		
		/*documentTagsFactory.query().then(function(data){
			console.log(documentList);
			console.log(2);
		});*/
		
		//$q.when(documentListFactory).then(function(data){
		//	console.log(data);
		//	console.log(2);
		//});
		$scope.tags = 'abc';
		var promise = $q.all([documentListFactory,documentTagsFactory.query(documentListFactory)]);
		
		promise.then(function(data){
		//console.log(data);
			//console.log(documentList);
			//console.log(3);
			//$scope.tags = 'aaaaaaa';
		});
		
		
		
		
		
		console.log($scope.tags);
		/* $http.get('http://3.cs/index.php?_json=1&_content=1').success(function(response){
			$scope.lists = response.data.models;
			$scope.page = response.data.page;
		});
		console.log($scope);
		console.log($http); */
	}]);
 -->

</body>
</html>