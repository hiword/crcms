<!DOCTYPE html>
<html ng-app="app">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../vendor/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="static/css/basic.css" />
<!-- 可选的Bootstrap主题文件（一般不用引入） -->
<link rel="stylesheet" href="../vendor/bootstrap/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="vendor/font-awesome/4.5.0/css/font-awesome.min.css" />
<title>Insert title here</title>
</head>
<body>
<div class="main-left pull-left">
	<div class="left-top">
		<h1 class="logo"><a href="###">CRCMS</a></h1>
		<div class="meta meta-1">致力于打造全面化的开源CMS系统</div>
		<div class="meta meta-2">记录我的生活，我的经验和笔记</div>
		<div class="meta meta-3"></div>
	</div>
	<div class="left-bottom">
		<p>
			<a href="###"><i class="fa fa-qq fa-lg"></i></a>
			<a href="###" class="ml10"><i class="fa fa-github fa-lg"></i></a>
			<a href="###" class="ml10"><i class="fa fa-envelope fa-lg"></i></a>
		</p>
		<p>
			Copyright <!-- © --><i class="fa fa-copyright"></i> 2013-2014
		</p>
	</div>
</div>
<div class="main-right pull-right">
	<div class="articles" ng-controller="listController">
		<article ng-repeat="list in lists">
			<a class="title" href="###">{{list.title}}</a>
			<div class="content"> 
				1.梁实秋说：你走，我不送你。你来，无论多大风多大雨，我要去接你。 2.海明威说：优于别人，并不高贵，真正的高贵应该是优于过去的自己。 3.三毛说：如果有来生，要做一棵树，站成永恒，没有悲伤的姿势：一半在尘土里安详，一半在空中飞扬；一半散落阴凉，一半沐浴阳光。非常沉默非常骄傲，从不依靠从不寻找。 4.顾漫...
			</div>
			<div class="article-info mt10 mb10">
				<span>
					<i class="glyphicon glyphicon-calendar"></i>
					{{ list.created_at * 1000 | date:'yyyy-MM-dd' }}
				</span>
				<span class="ml5">
					<i  class="glyphicon glyphicon-comment"></i>
					<span  class="ds-thread-count" data-replace="1" data-thread-key="2171">2</span>
				</span>
				<span class="ml5">
					<i class="glyphicon glyphicon-eye-open"></i>
					30
				</span>
				<span class="ml5"  ng-repeat="tag in tags">
					<i ng-show="tag.outside_id==list.id && $index==0"  class="glyphicon glyphicon-tag"></i>
					<a  ng-show="tag.outside_id==list.id"   rel="category tag" href="###">{{tag.name}},</a>
				</span>
			</div>
		</article>
		<div class="page">
			{{$page}}
		</div>
	</div>
</div>
<!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
<script src="../static/common/js/jquery-2.1.3.min.js"></script>
<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="../vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="../vendor/angularjs/1.4.8/angular.min.js"></script>
<script>
function strip_tags(input, allowed) {
	  //  discuss at: http://phpjs.org/functions/strip_tags/
	  // original by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
	  // improved by: Luke Godfrey
	  // improved by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
	  //    input by: Pul
	  //    input by: Alex
	  //    input by: Marc Palau
	  //    input by: Brett Zamir (http://brett-zamir.me)
	  //    input by: Bobby Drake
	  //    input by: Evertjan Garretsen
	  // bugfixed by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
	  // bugfixed by: Onno Marsman
	  // bugfixed by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
	  // bugfixed by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
	  // bugfixed by: Eric Nagel
	  // bugfixed by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
	  // bugfixed by: Tomasz Wesolowski
	  //  revised by: Rafał Kukawski (http://blog.kukawski.pl/)
	  //   example 1: strip_tags('<p>Kevin</p> <br /><b>van</b> <i>Zonneveld</i>', '<i><b>');
	  //   returns 1: 'Kevin <b>van</b> <i>Zonneveld</i>'
	  //   example 2: strip_tags('<p>Kevin <img src="someimage.png" onmouseover="someFunction()">van <i>Zonneveld</i></p>', '<p>');
	  //   returns 2: '<p>Kevin van Zonneveld</p>'
	  //   example 3: strip_tags("<a href='http://kevin.vanzonneveld.net'>Kevin van Zonneveld</a>", "<a>");
	  //   returns 3: "<a href='http://kevin.vanzonneveld.net'>Kevin van Zonneveld</a>"
	  //   example 4: strip_tags('1 < 5 5 > 1');
	  //   returns 4: '1 < 5 5 > 1'
	  //   example 5: strip_tags('1 <br/> 1');
	  //   returns 5: '1  1'
	  //   example 6: strip_tags('1 <br/> 1', '<br>');
	  //   returns 6: '1 <br/> 1'
	  //   example 7: strip_tags('1 <br/> 1', '<br><br/>');
	  //   returns 7: '1 <br/> 1'

	  allowed = (((allowed || '') + '')
	    .toLowerCase()
	    .match(/<[a-z][a-z0-9]*>/g) || [])
	    .join(''); // making sure the allowed arg is a string containing only tags in lowercase (<a><b><c>)
	  var tags = /<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,
	    commentsAndPhpTags = /<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;
	  return input.replace(commentsAndPhpTags, '')
	    .replace(tags, function($0, $1) {
	      return allowed.indexOf('<' + $1.toLowerCase() + '>') > -1 ? $0 : '';
	    });
	}

function substr(str, start, len) {
	  //  discuss at: http://phpjs.org/functions/substr/
	  //     version: 909.322
	  // original by: Martijn Wieringa
	  // bugfixed by: T.Wild
	  // improved by: Onno Marsman
	  // improved by: Brett Zamir (http://brett-zamir.me)
	  //  revised by: Theriault
	  //        note: Handles rare Unicode characters if 'unicode.semantics' ini (PHP6) is set to 'on'
	  //   example 1: substr('abcdef', 0, -1);
	  //   returns 1: 'abcde'
	  //   example 2: substr(2, 0, -6);
	  //   returns 2: false
	  //   example 3: ini_set('unicode.semantics',  'on');
	  //   example 3: substr('a\uD801\uDC00', 0, -1);
	  //   returns 3: 'a'
	  //   example 4: ini_set('unicode.semantics',  'on');
	  //   example 4: substr('a\uD801\uDC00', 0, 2);
	  //   returns 4: 'a\uD801\uDC00'
	  //   example 5: ini_set('unicode.semantics',  'on');
	  //   example 5: substr('a\uD801\uDC00', -1, 1);
	  //   returns 5: '\uD801\uDC00'
	  //   example 6: ini_set('unicode.semantics',  'on');
	  //   example 6: substr('a\uD801\uDC00z\uD801\uDC00', -3, 2);
	  //   returns 6: '\uD801\uDC00z'
	  //   example 7: ini_set('unicode.semantics',  'on');
	  //   example 7: substr('a\uD801\uDC00z\uD801\uDC00', -3, -1)
	  //   returns 7: '\uD801\uDC00z'

	  var i = 0,
	    allBMP = true,
	    es = 0,
	    el = 0,
	    se = 0,
	    ret = '';
	  str += '';
	  var end = str.length;

	  // BEGIN REDUNDANT
	  this.php_js = this.php_js || {};
	  this.php_js.ini = this.php_js.ini || {};
	  // END REDUNDANT
	  switch ((this.php_js.ini['unicode.semantics'] && this.php_js.ini['unicode.semantics'].local_value.toLowerCase())) {
	  case 'on':
	    // Full-blown Unicode including non-Basic-Multilingual-Plane characters
	    // strlen()
	    for (i = 0; i < str.length; i++) {
	      if (/[\uD800-\uDBFF]/.test(str.charAt(i)) && /[\uDC00-\uDFFF]/.test(str.charAt(i + 1))) {
	        allBMP = false;
	        break;
	      }
	    }

	    if (!allBMP) {
	      if (start < 0) {
	        for (i = end - 1, es = (start += end); i >= es; i--) {
	          if (/[\uDC00-\uDFFF]/.test(str.charAt(i)) && /[\uD800-\uDBFF]/.test(str.charAt(i - 1))) {
	            start--;
	            es--;
	          }
	        }
	      } else {
	        var surrogatePairs = /[\uD800-\uDBFF][\uDC00-\uDFFF]/g;
	        while ((surrogatePairs.exec(str)) != null) {
	          var li = surrogatePairs.lastIndex;
	          if (li - 2 < start) {
	            start++;
	          } else {
	            break;
	          }
	        }
	      }

	      if (start >= end || start < 0) {
	        return false;
	      }
	      if (len < 0) {
	        for (i = end - 1, el = (end += len); i >= el; i--) {
	          if (/[\uDC00-\uDFFF]/.test(str.charAt(i)) && /[\uD800-\uDBFF]/.test(str.charAt(i - 1))) {
	            end--;
	            el--;
	          }
	        }
	        if (start > end) {
	          return false;
	        }
	        return str.slice(start, end);
	      } else {
	        se = start + len;
	        for (i = start; i < se; i++) {
	          ret += str.charAt(i);
	          if (/[\uD800-\uDBFF]/.test(str.charAt(i)) && /[\uDC00-\uDFFF]/.test(str.charAt(i + 1))) {
	            // Go one further, since one of the "characters" is part of a surrogate pair
	            se++;
	          }
	        }
	        return ret;
	      }
	      break;
	    }
	    // Fall-through
	  case 'off':
	    // assumes there are no non-BMP characters;
	    //    if there may be such characters, then it is best to turn it on (critical in true XHTML/XML)
	  default:
	    if (start < 0) {
	      start += end;
	    }
	    end = typeof len === 'undefined' ? end : (len < 0 ? len + end : len + start);
	    // PHP returns false if start does not fall within the string.
	    // PHP returns false if the calculated end comes before the calculated start.
	    // PHP returns an empty string if start and end are the same.
	    // Otherwise, PHP returns the portion of the string from start to end.
	    return start >= str.length || start < 0 || start > end ? !1 : str.slice(start, end);
	  }
	  // Please Netbeans
	  return undefined;
	}
	var app = angular.module('app',[],['$httpProvider',function($httpProvider){
		$httpProvider.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded;charset=utf-8';
		
		/**
		   * The workhorse; converts an object to x-www-form-urlencoded serialization.
		   * @param {Object} obj
		   * @return {String}
		   */ 
		  var param = function(obj) {
		    var query = '', name, value, fullSubName, subName, subValue, innerObj, i;
		      
		    for(name in obj) {
		      value = obj[name];
		        
		      if(value instanceof Array) {
		        for(i=0; i<value.length; ++i) {
		          subValue = value[i];
		          fullSubName = name + '[' + i + ']';
		          innerObj = {};
		          innerObj[fullSubName] = subValue;
		          query += param(innerObj) + '&';
		        }
		      }
		      else if(value instanceof Object) {
		        for(subName in value) {
		          subValue = value[subName];
		          fullSubName = name + '[' + subName + ']';
		          innerObj = {};
		          innerObj[fullSubName] = subValue;
		          query += param(innerObj) + '&';
		        }
		      }
		      else if(value !== undefined && value !== null)
		        query += encodeURIComponent(name) + '=' + encodeURIComponent(value) + '&';
		    }
		      
		    return query.length ? query.substr(0, query.length - 1) : query;
		  };

		  // Override $http service's default transformRequest
		  $httpProvider.defaults.transformRequest = [function(data) {
		    return angular.isObject(data) && String(data) !== '[object File]' ? param(data) : data;
		  }];
	}]);
	
	//factory 使用于功能简单，类似于单例的一样，service适用于逻辑处理比较复杂的方法
	app.factory('documentListFactory',['$http','$q',function($http,$q){
		var documentListFactory = {
			documentIds:[],
			documents:function(){
				//申明一个延迟
				var deferred = $q.defer();
				
				//http数据获取
				$http.get('http://3.cs/index.php?_json=1')
				.success(function(response){
					
					//获取所有的document id
					angular.forEach(response.data.models,function(values){
						documentListFactory.documentIds.push(values.id);
					});
					
					//解析documents
					deferred.resolve(response.data);
				})
				.error(function(response){
					deferred.reject(response);
				});
				
				return deferred.promise;
			}
		}
		return documentListFactory;
	}]);
	
	app.factory('documentDataFactory',['$http','$q',function($http,$q){
		var documentDataFactory = {
			stripTagsData:[],
			datas:function(ids){
				var deferred = $q.defer();
				
				$http.post('http://3.cs/index.php/document/document-data',{
					'id':ids,
				})
				.success(function(response){
					angular.forEach(response.data.data,function(item){
						item.content = strip_tags(item);
						documentDataFactory.stripTagsData.push(item);
					});
					deferred.resolve(response.data.data);
				})
				.error(function(response){
					deferred.reject(response);
				})
				
				return deferred.promise;
			}
		};
		return documentDataFactory;
	}]);
	
	app.factory('documentTagsFactory',['$http','$q','documentListFactory',function($http,$q,documentListFactory){
		//申明一个延迟
		return {
			tags:function(ids)
			{
				var deferred = $q.defer();
				
				$http.post('http://3.cs/index.php/tags/assoc-tags',{
					'id':documentListFactory.documentIds,
					'model':'Document\\Models\\Document'
				})
				.success(function(response){
					
					deferred.resolve(response.data.tags);
				})
				.error(function(response){
					deferred.reject(response);
				});
				
				return deferred.promise;
			}
		}
	}]);
	
	app.controller('listController',['$scope','$http','$q','documentListFactory','documentTagsFactory','documentDataFactory',function($scope,$http,$q,documentListFactory,documentTagsFactory,documentDataFactory){
		/* documentListFactory.a().then(function(response]){
			$scope.lists = response
		}) */
		
		documentListFactory.documents().then(function(response){
			
			$scope.lists = response.models;
			
			documentTagsFactory.tags(documentListFactory.documentIds).then(function(response){
				console.log(response);
				$scope.tags = response;
			})
			
			documentDataFactory.datas(documentListFactory.documentIds).then(function(response){
				console.log(response);
				//$scope.datas = response;
			});
		});

		/* documentListFactory.then(function(response){
			if(response.status == 1000)
			{
				var ids = [];
				
				angular.forEach(response.data.models,function(values){
					ids.push(values.id);
				});
				
				documentTagsFactory.query(ids).then(function(response){
					console.log(response);
				});
			}
		}); */
		/* documentListFactory.then(function(data){
			
		}) */
	}]);
	
	
	
	
	
	$(function(){
		/* $.get('http://3.cs/index.php?_json=1&_content=1',function(data){
			console.log(data);
		}) */
	})
</script>

<!-- 

app.controller('listController',['$scope','$http','$q','documentListFactory','documentTagsFactory',function($scope,$http,$q,documentListFactory,documentTagsFactory){
		
		documentListFactory.then(function(data){
			console.log(data);
		});
		
		//var promise = documentListFactory;
		//then方法// 调用承诺API获取数据
		//var documentList = {};
		//var tagsList = {};
		/*documentListFactory.then(function(data){
			documentList = data.data.models;
			console.log(1);
		});*/
		
		/*documentTagsFactory.query().then(function(data){
			console.log(documentList);
			console.log(2);
		});*/
		
		//$q.when(documentListFactory).then(function(data){
		//	console.log(data);
		//	console.log(2);
		//});
		$scope.tags = 'abc';
		var promise = $q.all([documentListFactory,documentTagsFactory.query(documentListFactory)]);
		
		promise.then(function(data){
		//console.log(data);
			//console.log(documentList);
			//console.log(3);
			//$scope.tags = 'aaaaaaa';
		});
		
		
		
		
		
		console.log($scope.tags);
		/* $http.get('http://3.cs/index.php?_json=1&_content=1').success(function(response){
			$scope.lists = response.data.models;
			$scope.page = response.data.page;
		});
		console.log($scope);
		console.log($http); */
	}]);
 -->

</body>
</html>